<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-us"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2021"><meta name="generator" content="DITA-OT"><link rel="stylesheet" type="text/css" href="../commonltr.css"><link rel="stylesheet" type="text/css" href="../doc.css"><title>TLS in IBM Watson IoT Platform Message Gateway and Eclipse Amlen</title></head><body id="up00022_"><nav role="toc"><ul><li><a href="../welcome.html">Welcome</a></li><li><a href="../Overview/ov00000_.html">Eclipse Amlen</a><ul><li><a href="../Overview/ov00000_.html">Product overview</a></li><li><a href="../Planning/pl00001_.html">Planning</a></li><li><a href="../QuickStartGuide/qsg10000.html">Installing Eclipse Amlen  </a></li><li><a href="../Upgrading/up00001_.html">Upgrading</a><ul><li><a href="../Upgrading/up00014_.html">Upgrading and rolling back the software level of Eclipse Amlen</a></li><li><a href="../Upgrading/up00021_.html">Upgrading from IBM Watson IoT Platform Message Gateway to Eclipse Amlen</a><ul><li class="active"><a href="../Upgrading/up00022_.html">TLS in IBM Watson IoT Platform Message Gateway and Eclipse Amlen</a></li></ul></li><li><a href="../Upgrading/up00020_.html">Upgrading from IBM IoT MessageSight v2 (or above) to Eclipse Amlen</a></li><li><a href="../Upgrading/up00015_.html">Upgrading from IBM IoT MessageSight version 1.2</a></li></ul></li><li><a href="../Scenarios/sc00000_.html">End-to-end scenarios</a></li><li><a href="../Administering/ad00000_.html">Administering</a></li><li><a href="../AdministeringWebUI/ad00002_.html">Administering the Web UI</a></li><li><a href="../Bridge/br00010.html">Configuring the Bridge</a></li><li><a href="../Security/se00000_.html">Security</a></li><li><a href="../Monitoring/admin00008_.html">Monitoring and reporting</a></li><li><a href="../Backup/ba00000_.html">Backup and restore</a></li><li><a href="../Troubleshooting/tr10000_.html">Troubleshooting</a></li><li><a href="../Developing/develop_guide.html">Developing client applications</a></li><li><a href="../Reference/re00000_.html">Reference</a></li><li><a href="../glossary/glossary.html">Glossary</a></li></ul></li></ul></nav><main role="main"><article role="article" aria-labelledby="ariaid-title1">
    <h1 class="title topictitle1" id="ariaid-title1">TLS in <span class="ph">IBM Watson IoT Platform Message Gateway</span> and <span class="ph">Eclipse Amlen</span></h1>
    <div class="body">
    <section class="section"><h2 class="title sectiontitle">High Availability Pairing</h2>
        
        <p class="p"><span class="ph">IBM® Watson IoT Platform Message Gateway</span> (formally known as <span class="ph">IBM IoT MessageSight</span>) 
        allows two instances of the software to be put into an Active-Passive relationship to enable a fast failover mechanism to provide a Highly 
        Available system. The connection between the two instances can optionally have TLS enabled. This uses credentials in the binary to 
        secure the connection.</p>
        
        <p class="p"><span class="ph">IBM Watson IoT Platform Message Gateway</span> inherits this ability but uses a different set of default credentials.
        This means that you cannot pair a Message Gateway instance and Eclipse Amlen together using their respective default credentials. Pairing 
        them together is desirable as a migration strategy. There are two methods for allowing a pair to be created.</p>
        
        <p class="p">The first, and recommended way, is to provide matching credentials to both instances. This is also recommended for enhanced 
        security due to the default credentials being discoverable. A key and certificate can be placed in the keystore directory for 
        Message Gateway the default location is:/var/messagesight/data/certificates/keystoreFor Eclipse Amlen the default location 
        is:/var/lib/amlen-server/data/certificates/keystore</p>
        <p class="p">The key must be called HA_key.pem and must be in pem format.The certificate must be called HA_cert.pem and must be in pem format.
        The keystore location can be changed in the server.cfg.  <span class="ph">Eclipse Amlen</span> supports user provided 
        TLS credentials from the initial version. Message Gateway gained user provided SSL credentials in an ifix of 5.0.0.2. The 
        alternative method which can be used with previous versions of Message Gateway is to disable certificates for the connection. This 
        is done by setting RequireCertificates to false in the HighAvailability configuration of the <span class="ph">Eclipse Amlen</span> 
        Instance. An example of this is:</p>
        <pre class="pre codeblock"><code>
        curl -m 10 -u "${IMA_USER}" -k -X POST -d 
                '{ "HighAvailability": 
                        { "Group": "haPair1",
                          "EnableHA": true,
                          "StartupMode": "AutoDetect",
                          "RemoteDiscoveryNIC": "10.0.1.24",
                          "LocalReplicationNIC": "10.0.1.25",
                          "LocalDiscoveryNIC": "10.0.1.26",
                          "PreferredPrimary": true,
                          "UseSecuredConnections":true,
                          "RequireCertificates": false,
                        }
                 }' "${IMA_ADMIN}/configuration" 
        </code></pre>
        <p class="p">This method is recommended as a temporary solution for the migration and once the migration to Eclipse Amlen is complete the 
        setting should be turned off. Changes to this setting require a restart of the instance to take effect. If user provided credentials 
        are supplied then certificates are always required so it is not possible to pair Amlen instances with user provided credentials 
        with <span class="ph">IBM Watson IoT Platform Message Gateway</span> instances that do not support user provided credentials.</p>
    </section>
    <section class="section"><h2 class="title sectiontitle">Migrating HA Pairs to User Provided Credentials</h2>
        
        <p class="p">Migrating from a HA Pair using default credentials to user provided credentials requires the credentials to be uploaded 
        to the keystores on both instances, for <span class="ph">IBM Watson IoT Platform Message Gateway</span> the default location is:
        <span class="ph filepath">/var/messagesight/data/certificates/keystore</span>. For <span class="ph">IBM Watson IoT Platform Message Gateway</span> the
        default location is: <span class="ph filepath">/var/lib/amlen-server/data/certificates/keystore</span>. The key must be called 
        <span class="ph filepath">HA_key.pem</span> and must be in pem format. The certificate must be called <span class="ph filepath">HA_cert.pem</span> and 
        must be in pem format.The keystore location can be changed in the <span class="ph filepath">server.cfg</span>.</p>
        <p class="p">For details on how to create credentials see the Authentication Methods section.</p>
        <p class="p">The procedure is:</p>
        <ol class="ol">
            <li class="li">Place the key and certificate on the standby instance and define the truststore if using Certificate Authorities</li>
            <li class="li">Restart the standby instance.The standby instance will not become active in the pair. Example results from HighAvailability will be:
            <pre class="pre codeblock"><code>curl -m 10 -u "${IMA_USER}" -k -X GET "${IMA_ADMIN}/service/status/HighAvailability"
            Response from the Primary:
            {  "Version":"v1", 
               "HighAvailability": {
                   "Status": "Active",
                   "Enabled": true,
                   "Group": "haPair1",
                   "NewRole": "PRIMARY",
                   "OldRole": "PRIMARY",
                   "ActiveNodes": 1,
                   "SyncNodes": 1,
                   "PrimaryLastTime": "2021-05-05T16:48:22Z",
                   "PctSyncCompletion": -1, 
                   "ReasonCode": 0,
                   "RemoteServerName":"3ac46d703cde:9089"
               }
            }
            Running the command again against the rcently restarted secondary:
            curl  -u "${IMA_USER}" -k -X GET "${IMA_ADMIN}/service/status/HighAvailability"
            Response:
            {  "Version":"v1", 
               "HighAvailability": {
                   "Status": "Active",
                   "Enabled": true,
                   "Group": "haPair1",
                   "NewRole": "UNSYNC",
                   "OldRole": "UNSYNC",
                   "ActiveNodes": 0,
                   "SyncNodes": 0,
                   "PrimaryLastTime": "",
                   "PctSyncCompletion": -1,
                   "ReasonCode": 0,
                   "RemoteServerName":""
               }
            }
            </code></pre></li>
            <li class="li">Place the key and certificate on the primary instance and define the
            truststore if using Certificate Authorities.</li>
            <li class="li"> <p class="lines">Restart the primary instance<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The primary instance will restart and remain the primary instance<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The unsynchronized instance will start to synchronize and once completed will become a standby.</p>
            The initial HighAvailability status will show:
            <pre class="pre codeblock"><code>
            #Running the command against the primary
            curl -m 10 -u "${IMA_USER}" -k -X GET "${IMA_ADMIN}/service/status/HighAvailability
            #Response:
            "{  "Version":"v1",
                "HighAvailability": {
                    "Status": "Active",
                    "Enabled": true,
                    "Group": "haPair1",
                    "NewRole": "PRIMARY",
                    "OldRole": "UNSYNC",
                    "ActiveNodes": 2,
                    "SyncNodes": 1,
                    "PrimaryLastTime": "2021-05-05T16:48:39Z",
                    "PctSyncCompletion": 1,
                    "ReasonCode": 0,
                    "RemoteServerName":""
                }
            }
            #Running the command against the secondary
            curl -m 10 -u "${IMA_USER}" -k -X GET "${IMA_ADMIN}/service/status/HighAvailability"
            #Response:
            {  "Version":"v1",
               "HighAvailability": {
                   "Status": "Active",
                   "Enabled": true,
                   "Group": "haPair1",
                   "NewRole": "UNSYNC",
                   "OldRole": "UNSYNC",
                   "ActiveNodes": 2,
                   "SyncNodes": 0,
                   "PrimaryLastTime": "",
                   "PctSyncCompletion": -1,
                   "ReasonCode": 0,
                   "RemoteServerName":""
                }
            }
            </code></pre>
            Once the procedure has completed, they should return to:
            <pre class="pre codeblock"><code>
            curl -m 10 -u "${IMA_USER}" -k -X GET "${IMA_ADMIN}/service/status/HighAvailability"
            {  "Version":"v1",
               "HighAvailability": {
                   "Status": "Active",
                   "Enabled": true,
                   "Group": "haPair1",
                   "NewRole": "PRIMARY",
                   "OldRole": "PRIMARY",
                   "ActiveNodes": 2,
                   "SyncNodes": 2,
                   "PrimaryLastTime": "2021-05-05T17:16:07Z",
                   "PctSyncCompletion": -1,
                   "ReasonCode": 0,
                   "RemoteServerName":"3ac46d703cde:9089"
                }
            }
            curl -m 10 -u "${IMA_USER}" -k -X GET "${IMA_ADMIN}/service/status/HighAvailability"
            {  "Version":"v1",
               "HighAvailability": {
                   "Status": "Active",
                   "Enabled": true,
                   "Group": "haPair1",
                   "NewRole": "STANDBY",
                   "OldRole": "UNSYNC",
                   "ActiveNodes": 2,
                   "SyncNodes": 2,
                   "PrimaryLastTime": "",
                   "PctSyncCompletion": -1,
                   "ReasonCode": 0,
                   "RemoteServerName":"3704cacfea12:9089"
                }
            }
            </code></pre>
            </li>
        </ol>
    </section>
    <section class="section"><h2 class="title sectiontitle">Clustering</h2>
        
        <p class="p"><span class="ph">IBM Watson IoT Platform Message Gateway</span> allows multiple instances of the software to be put into a cluster to provide scalability. 
        The connection between the instances can optionally have TLS enabled. This uses credentials in the binary to secure the connection.</p>

        <p class="p"><span class="ph">Eclipse Amlen</span> inherits this ability but uses a different set of default credentials.</p>
        
        <p class="p">This means that you cannot cluster <span class="ph">IBM Watson IoT Platform Message Gateway</span> instances and 
        <span class="ph">Eclipse Amlen</span> instances together using their respective default credentials. There are two methods for 
        allowing a cluster to be created.</p>
        
        <p class="p">The first, and recommended way, is to provide matching credentials to all instances. This is also 
        recommended for enhanced security due to the default credentials being discoverable. 
        A key and certificate can be placed in the keystore directory for <span class="ph">IBM Watson IoT Platform Message Gateway</span>the default location 
        is: <span class="ph filepath">/var/messagesight/data/certificates/keystore</span>. 
        For <span class="ph">Eclipse Amlen</span> the default location is: <span class="ph filepath">/var/lib/amlen-server/data/certificates/keystore</span>
        The key must be called <span class="ph filepath">Cluster_key.pem</span> and must be in pem format. The certificate must be called <span class="ph filepath">Cluster_cert.pem</span> 
        and must be in pem format.The keystore location can be changed in the server.cfg.</p>
        
        <p class="p"><span class="ph">Eclipse Amlen</span> supports user provided SSL credentials from the initial version. 
        <span class="ph">IBM Watson IoT Platform Message Gateway</span> gained user provided SSL credentials in an ifix of v5.0.0.2. 
        For details on how to create credentials see the Authentication Methods section.</p>
        
        <p class="p">The alternative method which can be used with previous versions of Message Gateway
        is to disable certificates for the connection. This is done by setting RequireCertificates to false in the ClusterMembership configuration on the 
        <span class="ph">Eclipse Amlen</span> instances. An example of this is:</p>
        <pre class="pre codeblock"><code>
        curl -X POST    -d  "{
              \"ClusterMembership\": {
                    \"EnableClusterMembership\": true,
                    \"ControlAddress\": \"10.0.1.5\",
                    \"MessagingAddress\": \"10.0.1.5\",
                    \"DiscoveryServerList\":\"10.0.1.5:9104,10.0.1.4:9104\",
                    \"UseMulticastDiscovery\": false,
                    \"ClusterName\": \"MyCluster\",
                    \"MessagingUseTLS\":true,
                    \"CertificatesRequired\":false}
              }"  http://127.0.0.1:9089/ima/v1/configuration
        </code></pre>
        <p class="p">This method is recommended as a temporary solution once all instances support user provided credentials they should be provided.
         Changes to this setting require a restart of the instance to take effect. If user provided credentials are supplied, then certificates are always 
         required so it is not possible to cluster <span class="ph">Eclipse Amlen</span> instances with user provided credentials with 
         <span class="ph">IBM Watson IoT Platform Message Gateway</span> instances that do not support user provided credentials.</p>
    </section>
    <section class="section"><h2 class="title sectiontitle">Migrating A Cluster To User Provided Credentials</h2>
        
        <p class="p">Migrating from a Cluster using default credentials to user provided credential uploaded to the keystores on all instances.</p>
        <p class="p">For details on how to create credentials see the Authentication Methods section.</p>
        <p class="p">During this procedure, instance will in turn be removed form the cluster, they will not be able to re-join the cluster until 
        all instances have been restarted.</p>
        <p class="p">The procedure is:</p>
        <ol class="ol">
            <li class="li">Place the credentials (key, certificate and cafile if appropriate) on all instances.</li>
            <li class="li">If using High Availability pairing restart all standby instances wait for them to resynchronize.</li>
            <li class="li">Select one instance as the last instance to restart.</li>
            <li class="li">Restart each instance in turn checking that the cluster status on the last instance has the disconnected server 
               count incremented:
               <pre class="pre codeblock"><code>
               curl -m 10 -u "${IMA_USER}" -k -X GET "${IMA_ADMIN}/service/status/Cluster"
                    {  "Version":"v1",
                       "Cluster": {
                           "Status": "Active",
                           "Name": "MyCluster",
                           "Enabled": true,
                           "ConnectedServers": 2,
                           "DisconnectedServers": 1
                       }
                    }
                </code></pre></li>
            <li class="li">Restart the last instance</li>
            <li class="li">Wait for the cluster status to be available on the last instance and check that the connected server count
                is back to what it started as:
                <pre class="pre codeblock"><code>
                curl -m 10 -u "${IMA_USER}" -k -X GET "${IMA_ADMIN}/service/status/Cluster"
                    {  "Version":"v1",
                       "Cluster": {
                           "Status": "Active",
                           "Name": "MyCluster",
                           "Enabled": true,
                           "ConnectedServers": 3,
                           "DisconnectedServers": 0 
                        }
                    }
                </code></pre></li>
        </ol>
    </section>
    <section class="section"><h2 class="title sectiontitle">Authentication Methods</h2>
        
        <p class="p">As well as simple key certificate pairs being used which requires the same key and certificate to be placed
        on all the instances in the HA pair or cluster. Certificate Authorities can also be used. When enabled the product
        uses peer-to-peer secure connections.</p>
        <p class="p"><strong class="ph b">Without Certificate Authorities</strong></p>
        <p class="p">When not using Certificate Authorities each instance in the system require the same key and certificate to be set.
        An example to create the key and self-signed certificate using openssl is:</p>
        <pre class="pre codeblock"><code>
        openssl genrsa -out ha_keydata 3072
        openssl req -new -x509 -key HA_key.pem -out HA_cert.pem -days 360
        </code></pre>
        <p class="p">This will produce the key and certificate in the correct pem format. In this specific example the key will be between the lines:</p>
        <pre class="pre codeblock"><code>-----BEGIN RSA PRIVATE KEY-----</code></pre>
        <p class="p">And:</p>
        <pre class="pre codeblock"><code>-----END RSA PRIVATE KEY-----</code></pre>
        <p class="p">The certificate will be between:</p>
        <pre class="pre codeblock"><code>-----BEGIN CERTIFICATE-----</code></pre>
        And:
        <pre class="pre codeblock"><code>-----END CERTIFICATE-----</code></pre>
        <p class="p">If the key or certificate file does not contain a BEGIN and END, then it may have been created in the wrong format.</p>
        <p class="p">Once the key and certificate have been created, they can be copied into the correct location of each instance.</p>
        <p class="p"><strong class="ph b">With Certificate Authorities</strong></p>
        <p class="p">When using Certificate Authorities each instance requires a key and certificate to be set in the same way as without 
        Certificate Authorities. However, as long as the credentials are created from an authorized system they do not have to
        be the same on each instance. To set the authorities the root and any intermediate certificates need to be provided.</p>
        <p class="p">An example to create a root certificate, an intermediate certificate, and two leaf certificates is:</p>
        <pre class="pre codeblock"><code>
        openssl genrsa -out root.key 2048
        openssl req -new -key root.key -out root.csr -config root_req.config
        openssl ca -in root.csr -out root.pem -config root.config -selfsign -extfile ca.ext -days 1095
        openssl genrsa -out intermediate.key 2048
        openssl req -new -key intermediate.key -out intermediate.csr -config intermediate_req.config
        openssl ca -in intermediate.csr -out intermediate.pem -config root.config -extfile ca.ext -days 730
        openssl genrsa -out leaf.key 2048
        openssl req -new -key leaf.key -out leaf.csr -config leaf_req.config
        openssl ca -in leaf.csr -out leaf.pem -config intermediate.config -days 365 -batch
        openssl genrsa -out leaf2.key 2048
        openssl req -new -key leaf2.key -out leaf2.csr -config leaf_req.config
        openssl ca -in leaf2.csr -out leaf2.pem -config intermediate.config -days 365 -batch
        </code></pre>
        <p class="p">The files produced by this sequence that are required for authentication are:</p>
        <dl class="dl">
        <dt class="dt dlterm">root.pem</dt><dd class="dd">the root certificate</dd>
        <dt class="dt dlterm">Intermediate.pem</dt><dd class="dd">the intermediate certificate</dd>
        <dt class="dt dlterm">leaf.key</dt><dd class="dd">the key that will be used on the first instance</dd>
        <dt class="dt dlterm">leaf.pem</dt><dd class="dd">the certificate that will be used on the first instance</dd>
        <dt class="dt dlterm">leaf2.key</dt><dd class="dd">the key that will be used on the second instance</dd>
        <dt class="dt dlterm">leaf2.pem</dt><dd class="dd">the certificate that will be used on the second instance</dd>
        </dl>
        <p class="p">(All files will be in pem format)</p>
        <p class="p">For High Availability Pairing The leaf files need to be placed in the keystore of the
        corresponding instance and renamed to HA_key.pem and HA_cert.pem. For Clustering the leaf files need to be placed in the 
        keystore of the corresponding instance and renamed to Cluster_key.pem and Cluster_cert.pem. To provide the 
        Certificate Authorities a CAFile must be constructed from the root certificate and intermediate certificate and 
        placed in the truststore in a file called HA_cafile.pem or Cluster_cafile.pem this can be done via:</p>
        <pre class="pre codeblock"><code>
        cat root.pem &gt; HA_cafile.pem
        cat intermediate.pem &gt;&gt; HA_cafile.pem
        </code></pre>
        <p class="p">When an instance’s certificate expires a new key and certificate can be created (using the intermediate credentials) 
        and uploaded to the instance and once that instance has been restarted the instance will be authenticated without 
        having to change the other instances.</p>
        
        <p class="p">If using High Availability Pairing and Clustering then it is possible to use file links to have the same credentials
        used for both systems eg:</p>
        <pre class="pre codeblock"><code>
        ln /var/messagesight/data/certificates/keystore/HA_cert.pem     /var/messagesight/data/certificates/keystore/Cluster_cert.pem
        ln /var/messagesight/data/certificates/keystore/HA_key.pem      /var/messagesight/data/certificates/keystore/Cluster_key.pem
        ln /var/messagesight/data/certificates/truststore/HA_cafile.pem /var/messagesight/data/certificates/truststore/Cluster_cert.pem
        </code></pre>
        <p class="p"><strong class="ph b">Certification Revocation List</strong></p>
        <p class="p">If a certificate has become compromised prior to its expiration date then it can be added to a Certification 
        Revocation List (CRL). The product supports a single consolidated CRL file in pem format for each connection.</p>
        
        <p class="p">The CRL file for High Availability pairing must be:</p>
        <span class="ph filepath">{truststore-directory}/HA_crl/crl.pem</span>
        <p class="p">The CRL file for Clustering must be:</p>
        <span class="ph filepath">{truststore-directory}/Cluster_crl/crl.pem</span>
    </section>
    </div>
<nav role="navigation" class="related-links"><div class="familylinks"><div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../Upgrading/up00021_.html" title="If you are a IBM Watson IoT Platform Message Gateway customer who is upgrading to Eclipse Amlen version 0.1, you will find that normal product operation is almost entirely unchanged by the renaming of the product. Migration requires some simple steps outlined here.">Upgrading from IBM Watson IoT Platform Message Gateway to Eclipse Amlen</a></div></div></nav></article></main></body></html>